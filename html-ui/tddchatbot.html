<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador Â  
 de Tests para Chatbot</title>
    </head>
<body>
    <h1>Creador de Tests</h1>

    <div id="test-container">
        <div id="test-list" style="margin-bottom: 20px;">
            <!-- Dynamic test entries will appear here -->
        </div>
    </div>
    
    <!-- Elementos para mostrar progreso -->
    <!-- <progress></progress> https://html.spec.whatwg.org/multipage/form-elements.html#the-progress-element -->

    <input id="credentials" type="password" placeholder="credentials" />

    <input id="question" type="text" placeholder="question"/>
    <input id="response-evaluation" type="text" placeholder="response evaluation"/>
    <input id="response" type="text" placeholder="response" readonly/>
    <button id="add-test">Add test</button>
    <button id="run-all">Run all</button>
    <label for="resultado">Result:</label>
    <input type="text" id="resultado" readonly value="passed">
    <input type="text" id="context" placeholder="context"/>
    <label for="latest-id">Latest test id</label>
    <input type="text" id="latest-id" readonly value="0">

    <script>
        const addTestButton = document.getElementById('add-test');
        const runAllButton = document.getElementById('run-all');
        const questionInput = document.getElementById('question');
        const responseEvaluationInput = document.getElementById('response-evaluation');
        const resultInput = document.getElementById('resultado');
        const testContainer = document.getElementById('test-container');
        const credentials = document.getElementById('credentials');
        const context = document.getElementById('context');
        const response_field = document.getElementById('response');
        const latestId_field = document.getElementById('latest-id');
        const testList = document.getElementById('test-list');

        async function getChatCompletion(question){
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${credentials.value}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: [
                                {
                                    role: "system",
                                    content: [
                                        {
                                            type: "text",
                                            text: context.value
                                        }
                                    ]
                                },
                                {
                                    role: "user",
                                    content: [
                                        {
                                            type: "text",
                                            text: question
                                        }
                                    ]
                                }
                            ],
                            n: 1,
                            stop: null,
                            temperature: 0.5
                        })
                    });

                    const data = await response.json();
                    const generatedResponse = data.choices[0].message.content.trim();
                    return generatedResponse
        }

        addTestButton.addEventListener('click', async function(){
            latestId_field.value = Number(latestId_field.value) +1

            const testId = latestId_field.value
            const testDiv = document.createElement('div');
                testDiv.style.marginBottom = '10px';

                testDiv.innerHTML = `
                    <label for="test${testId}question">Test${testId} Question</label>
                    <input id="test${testId}question" type="text" value="${questionInput.value}" readonly>
                    <label for="test${testId}response-evaluation">Test${testId} Response Evaluation</label>
                    <input id="test${testId}response-evaluation" type="text" value="${responseEvaluationInput.value}" readonly>
                `;

                testList.appendChild(testDiv);
        })

        runAllButton.addEventListener('click', async () => {
            const response = await getChatCompletion(questionInput.value)
            response_field.value = response
            const responseEvaluation = await getChatCompletion(`Is the text "${response}" matching the criteria "${responseEvaluationInput.value}"? answer only "true" or "false"`)

            let testPassed = responseEvaluation.indexOf("true") != -1
            resultInput.value = testPassed ? "passed" : "failed";
        });
    </script>

    </body>
</html>