<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Tests para Chatbot</title>
    <style>
        body {
        font-family: Arial, sans-serif;
        margin: 2rem;
        }

        h1 {
        text-align: center;
        margin-bottom: 1rem;
        }

        #test-container {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 1rem;
        margin-bottom: 1rem;
        }

        #test-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        }

        .test-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        }

        .test-item label {
        font-weight: bold;
        }

        input[type="text"], input[type="password"] {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 3px;
        }

        input[readonly] {
        background-color: #eee;
        }

        button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 3px;
        background-color: #4CAF50; /* Green */
        color: white;
        cursor: pointer;
        margin-right: 1rem;
        }

        button:hover {
        background-color: #3e8e41;
        }

        label {
        display: block;
        margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <h1>Creador de Tests</h1>

    <div id="test-container">
        <div id="test-list" style="margin-bottom: 20px;">
            <!-- Dynamic test entries will appear here -->
        </div>
    </div>

    <input id="credentials" type="password" placeholder="credentials" />
    <input id="question" type="text" placeholder="question"/>
    <input id="response-evaluation" type="text" placeholder="response evaluation"/>
    <input id="response" type="text" placeholder="response" readonly/>
    <button id="add-test">Add test</button>
    <button id="run-all">Run all</button>
    <label for="resultado">Result:</label>
    <input type="text" id="resultado" readonly value="passed">
    <input type="text" id="context" placeholder="context"/>
    <label for="latest-id">Latest test id</label>
    <input type="text" id="latest-id" readonly value="0">

    <script>
        const addTestButton = document.getElementById('add-test');
        const runAllButton = document.getElementById('run-all');
        const questionInput = document.getElementById('question');
        const responseEvaluationInput = document.getElementById('response-evaluation');
        const resultInput = document.getElementById('resultado');
        const credentialsInput = document.getElementById('credentials');
        const contextInput = document.getElementById('context');
        const responseField = document.getElementById('response');
        const latestIdField = document.getElementById('latest-id');
        const testList = document.getElementById('test-list');

        // Function to call the OpenAI API and get a completion
        async function getChatCompletion(question) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${credentialsInput.value}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        { role: "system", content: contextInput.value },
                        { role: "user", content: question }
                    ],
                    n: 1,
                    stop: null,
                    temperature: 0.5
                })
            });

            const data = await response.json();
            return data.choices[0].message.content.trim();
        }

        // Function to add a new test to the test list
        function addTest() {
            const testId = Number(latestIdField.value) + 1;
            latestIdField.value = testId;

            const testDiv = document.createElement('div');
            testDiv.style.marginBottom = '10px';
            testDiv.innerHTML = `
                <label for="test${testId}question">Test${testId} Question</label>
                <input id="test${testId}question" type="text" value="${questionInput.value}" readonly>
                <label for="test${testId}response-evaluation">Test${testId} Response Evaluation</label>
                <input id="test${testId}response-evaluation" type="text" value="${responseEvaluationInput.value}" readonly>
            `;

            testList.appendChild(testDiv);
        }

        // Function to evaluate the response of all tests
        async function evaluateAllTests() {
            const response = await getChatCompletion(questionInput.value);
            responseField.value = response;

            const responseEvaluationQuestion = `Is the text "${response}" matching the criteria "${responseEvaluationInput.value}"? answer only "true" or "false"`;
            const evaluationResponse = await getChatCompletion(responseEvaluationQuestion);

            const testPassed = evaluationResponse.indexOf("true") !== -1;
            resultInput.value = testPassed ? "passed" : "failed";
        }

        addTestButton.addEventListener('click', addTest);
        runAllButton.addEventListener('click', evaluateAllTests);
    </script>
</body>
</html>